Pintos 4: 파일 디스크립터, 실행 파일 쓰기 거부
=========================================
2013011037 류형욱

과제의 목표 및 요구사항
-------------------
파일 디스크립터와 파일 디스크립터 테이블을 구현합니다.
실행 중인 프로세스의 실행 파일에 쓰기 작업을 할 수 없도록 합니다.
Pintos Project 2에서 다루는 모든 시스템 콜을 구현합니다. Project 2, userprog 테스트의 모든 테스트 케이스를 통과하도록 합니다. 이번에 완성할 시스템 콜은 open, filesize, read, write, seek, tell, close입니다. Pintos 문서에 따르면, 각 시스템 콜의 사양은 다음과 같습니다.

### open

파일을 열고 파일 디스크립터를 반환합니다. 실패한 경우 -1을 반환합니다. 파일 디스크립터 0과 파일 디스크립터 1은 표준 입력과 표준 출력으로 예약되어 있습니다. 파일 하나를 여러 번 열 수 있으며, 여러 파일 디스크립터의 닫기 동작, 파일에서의 위치와 같은 정보는 독립적이어야 합니다.

### filesize

파일 디스크립터에 해당하는 열린 파일의 크기를 반환합니다.

### read

파일 디스크립터에 해당하는 열린 파일에서 size만큼의 데이터를 읽어 버퍼에 씁니다. 파일에서 성공적으로 읽은 데이터의 바이트 수를 반환합니다. 파일 끝에 도달한 것이 아니고 파일을 읽을 수 없는 경우에는 -1을 반환합니다. 파일 디스크립터 번호가 0, STDIN_FILENO라면 키보드에서 입력을 받습니다.

### write

버퍼에서 size만큼의 데이터를 읽어 파일 디스크립터에 해당하는 열린 파일에 씁니다. 파일에 성공적으로 쓴 데이터의 바이트 수를 반환합니다. 현재 각 파일의 크기는 고정된 값입니다. 파일 디스크립터 번호가 1, STDOUT_FILENO이면 화면으로 출력을 보냅니다.

### seek

파일 디스크립터에 해당하는 열린 파일에서 현재 위치를 변경합니다. 파일의 끝을 초과하는 위치가 주어진 경우에도 문제 없이 동작할 수 있습니다.

### tell

파일 디스크립터에 해당하는 열린 파일에서 직후 위치를 반환합니다.

### close

파일 디스크립터에 해당하는 열린 파일을 닫습니다.

문제를 해결하기 위한 Pintos 분석 내용
--------------------------------
- 파일 하나를 여러 번 연 경우에, 복수의 struct file은 하나의 struct inode를 가리키는 포인터를 가집니다.
- file_close 함수는 파일을 닫으면서 파일의 쓰기 금지 설정을 함께 해제합니다. 또 NULL을 넣어도 안전합니다.
- 표준 입력과 표준 출력은 input_getc 함수와 putbuf 함수로 처리할 수 있습니다.
- 여러 프로세스가 동시에 한 파일에 접근할 수 있으므로, 커널에서 동기화해야 합니다.
- 프로세스가 파일을 닫지 않고 종료하여도 커널이 안전하게 정리해야 합니다.
- Pintos는 바로 사용할 수 있는 lock을 제공합니다.

해결 과정
-------
1. 스레드 커널 자료 구조에 "파일 디스크립터 테이블"과 "프로세스 실행 파일을 열고 쓰기 금지한 파일"을 넣을 수 있도록 합니다. 새로 할당한 페이지 하나를 파일 디스크립터 테이블 저장 공간으로 사용합니다. 파일 디스크립터 테이블은 파일 커널 자료 구조에 대한 포인터의 배열입니다.
1. 스레드가 생성될 때 앞에서 새롭게 추가한 것들을 초기화하고, 스레드가 종료될 때 정리하도록 합니다. 파일 디스크립터 테이블에서 아직 닫지 않은 모든 파일과 프로세스 실행 파일을 닫도록 합니다. 마지막으로 파일 디스크립터 테이블을 저장하기 위하여 할당한 메모리를 해제합니다.
1. 프로세스의 파일 디스크립터 테이블에 파일을 추가, 검색, 삭제하는 작업을 편리하기 수행하기 위한 여러 함수를 정의합니다.
1. Pintos 파일 시스템에서 제공하는 함수와 변경한 자료 구조, 새 함수를 조합하여 시스템 콜을 구현합니다.
1. 프로세스를 메모리로 적재할 때 실행 파일에 대하여 쓰기를 금지합니다. 실행 파일을 바로 닫지 않고, 프로세스가 종료될 때 닫도록 합니다. 적재에 실패한 경우 프로세스를 바로 종료하므로 실행 파일은 곧 닫히게 되며 특별한 처리는 요구되지 않습니다. 파일을 열고 쓰기 금지를 설정하는 동안 다른 스레드가 실행될 수 있으므로 락을 이용하여 동기화합니다.
1. 유저 프로세스에 의한 페이지 폴트가 발생했을 때 해당 스레드를 강제로 종료하도록 페이지 폴트 핸들러를 변경합니다. 결과적으로 multi-oom 테스트의 빠듯한 상황 테스트를 통과하게 됩니다.

결과
---
모든 테스트를 통과합니다.

참조
---
운영체제 및 시스템 프로그래밍 실습 자료와 Pintos 문서를 참조하였습니다.